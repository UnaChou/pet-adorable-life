{% extends "base.html" %}

{% block title %}Pet Life - Pet Adorable Life{% endblock %}

{% block content %}
<nav class="nav-bar">
    <a href="/" class="logo">Pet Adorable Life</a>
    <ul class="nav-links">
        <li><a href="/">é¦–é </a></li>
        <li><a href="/product/analyze">å•†å“åˆ†æ</a></li>
        <li><a href="/organize" class="active">Pet Life</a></li>
        <li><a href="/diary">å¯µç‰©æ—¥è¨˜</a></li>
    </ul>
</nav>

<main class="organize-page">
    <section class="organize-hero">
        <h1>ğŸ“‹ Pet Life</h1>
        <p>çµæ§‹åŒ–æ•´ç†å•†å“è³‡è¨Šèˆ‡å¯µç‰©æ—¥è¨˜ï¼Œä¸€ç›®äº†ç„¶</p>
    </section>

    <div class="tabs-container">
        <div class="tabs-header">
            <button class="tab-btn active" data-tab="products-tab">ğŸ“¦ å•†å“åˆ—è¡¨</button>
            <button class="tab-btn" data-tab="diaries-tab">ğŸ“” å¯µç‰©æ—¥è¨˜</button>
        </div>

        <div class="tab-content active" id="products-tab">
            <div class="tab-actions">
                <button type="button" class="btn-toggle-add" id="btnToggleAddProduct">â• æ–°å¢å•†å“</button>
            </div>

            <section class="organize-add" id="addProductSection" style="display: none;">
                <h2>æ–°å¢å•†å“</h2>
                <form action="{{ url_for('organize_add') }}" method="post" class="add-form">
                    <div class="form-group">
                        <label for="title">å•†å“åç¨±</label>
                        <input type="text" id="title" name="title" placeholder="ä¾‹å¦‚ï¼šæ­å¥‡æ–¯ç„¡ç©€æˆçŠ¬é£¼æ–™" maxlength="200">
                    </div>
                    <div class="form-group">
                        <label for="summary">å•†å“æ‘˜è¦</label>
                        <textarea id="summary" name="summary" rows="5" placeholder="è¼¸å…¥å•†å“æè¿°ã€ç‰¹è‰²è¦é»ç­‰..."></textarea>
                    </div>
                    <button type="submit" class="btn-add">åŠ å…¥åˆ—è¡¨</button>
                </form>
            </section>

            <section class="organize-list">
                <div class="list-header">
                    <h2>å•†å“åˆ—è¡¨ <span class="count">å…± {{ products|length }} é …</span></h2>
                </div>

                {% if products %}
                <form action="{{ url_for('organize_remove_batch') }}" method="post" id="batch-form"
                    onsubmit="return confirmBatchDelete(this);">
                    <div class="product-cards timeline-list">
                        {% for product in products %}
                        <article class="product-card timeline-item">
                            <div class="timeline-dot"></div>
                            <label class="product-checkbox">
                                <input type="checkbox" name="product_ids" value="{{ product.id }}"
                                    class="product-id-checkbox">
                            </label>
                            <div class="product-card-body">
                                <div class="product-meta">
                                    <span class="product-id">#{{ product.id }}</span>
                                    <span class="product-dates">
                                        å»ºç«‹ï¼š{{ product.created_at.strftime('%Y-%m-%d %H:%M') if product.created_at else
                                        '-' }}
                                        {% if product.updated_at %}
                                        Â· ç·¨è¼¯ï¼š{{ product.updated_at.strftime('%Y-%m-%d %H:%M') }}
                                        {% endif %}
                                    </span>
                                </div>
                                <h3 class="product-title">{{ product.title }}</h3>
                                <div class="product-summary">{{ product.summary|replace('\n', '<br>')|safe }}</div>
                            </div>
                            <div class="product-card-actions">
                                <a href="{{ url_for('organize_edit', product_id=product.id) }}" class="btn-edit"
                                    title="ç·¨è¼¯">âœ</a>
                                <button type="submit" form="single-del-{{ product.id }}" class="btn-remove"
                                    title="ç§»é™¤æ­¤é …">âœ•</button>
                            </div>
                        </article>
                        {% endfor %}
                    </div>
                    <div class="batch-submit-row">
                        <button type="submit" class="btn-batch-remove" title="åˆªé™¤æ‰€é¸é …ç›®">åˆªé™¤æ‰€é¸</button>
                    </div>
                </form>
                {% for product in products %}
                <form id="single-del-{{ product.id }}" action="{{ url_for('organize_remove', product_id=product.id) }}"
                    method="post" class="hidden-form" onsubmit="return confirm('ç¢ºå®šè¦åˆªé™¤æ­¤å•†å“å—ï¼Ÿ');">
                </form>
                {% endfor %}
                {% else %}
                <div class="empty-state">
                    <span class="empty-icon">ğŸ“¦</span>
                    <p>å°šç„¡å•†å“ï¼Œé»æ“Šã€Œâ• æ–°å¢å•†å“ã€æˆ–å¾ <a href="/product/analyze">å•†å“åˆ†æ</a> åŠ å…¥</p>
                </div>
                {% endif %}
            </section>
        </div>

        <div class="tab-content" id="diaries-tab">
            <section class="diary-list">
                {% if diaries %}
                <form action="{{ url_for('diary_remove_batch') }}" method="post" id="diary-batch-form"
                    onsubmit="return confirmDiaryBatchDelete(this);">
                    <div class="list-header">
                        <h2>æ—¥è¨˜åˆ—è¡¨ <span class="count">å…± {{ diaries|length }} å‰‡</span></h2>
                    </div>
                    <div class="diary-cards timeline-list">
                        {% for d in diaries %}
                        <article class="diary-card timeline-item">
                            <div class="timeline-dot"></div>
                            <label class="diary-checkbox">
                                <input type="checkbox" name="diary_ids" value="{{ d.id }}" class="diary-id-checkbox">
                            </label>
                            <div class="diary-card-body">
                                {% if d.image_base64 %}
                                <div class="diary-image-wrapper">
                                    <img src="{{ d.image_base64 }}" alt="Diary Image" class="diary-thumbnail">
                                </div>
                                {% endif %}
                                <div class="diary-meta">
                                    <span class="diary-id">#{{ d.id }}</span>
                                    <span class="diary-dates">
                                        {{ d.created_at.strftime('%Y-%m-%d %H:%M') if d.created_at else '-' }}
                                    </span>
                                </div>
                                {% if d.title %}
                                <h4 class="diary-title">{{ d.title }}</h4>
                                {% endif %}
                                <div class="diary-emotion">{{ d.main_emotion }}</div>
                                <div class="diary-describe">{{ d.describe_text|replace('\n', '<br>')|safe }}</div>
                                {% if d.memo %}
                                <div class="diary-memo">
                                    <strong>å‚™è¨»ï¼š</strong>{{ d.memo|replace('\n', '<br>')|safe }}
                                </div>
                                {% endif %}
                            </div>
                            <div class="diary-card-actions">
                                <button type="submit" form="organize-diary-single-del-{{ d.id }}" class="btn-remove"
                                    title="ç§»é™¤æ­¤é …">âœ•</button>
                            </div>
                        </article>
                        {% endfor %}
                    </div>
                    <div class="batch-submit-row">
                        <button type="submit" class="btn-batch-remove" title="åˆªé™¤æ‰€é¸æ—¥è¨˜">åˆªé™¤æ‰€é¸</button>
                    </div>
                </form>
                {% for d in diaries %}
                <form id="organize-diary-single-del-{{ d.id }}" action="{{ url_for('diary_remove_batch') }}"
                    method="post" class="hidden-form" onsubmit="return confirm('ç¢ºå®šè¦åˆªé™¤æ­¤æ—¥è¨˜å—ï¼Ÿ');">
                    <input type="hidden" name="diary_ids" value="{{ d.id }}">
                </form>
                {% endfor %}
                {% else %}
                <div class="list-header">
                    <h2>æ—¥è¨˜åˆ—è¡¨ <span class="count">å…± 0 å‰‡</span></h2>
                </div>
                <div class="empty-state">
                    <span class="empty-icon">ğŸ“”</span>
                    <p>å°šç„¡æ—¥è¨˜ï¼Œè«‹å‰å¾€ <a href="/diary">å¯µç‰©æ—¥è¨˜</a> æ–°å¢</p>
                </div>
                {% endif %}
            </section>
        </div>
    </div>
</main>
<script>
    (function () {
        // Tabs functionality
        const tabBtns = document.querySelectorAll('.tab-btn');
        const tabContents = document.querySelectorAll('.tab-content');

        function switchTab(tabId) {
            // Remove active class from all
            tabBtns.forEach(b => b.classList.remove('active'));
            tabContents.forEach(c => c.classList.remove('active'));

            // Add active class to matched tab and corresponding content
            const targetBtn = document.querySelector(`.tab-btn[data-tab="${tabId}"]`);
            if (targetBtn) {
                targetBtn.classList.add('active');
                document.getElementById(tabId).classList.add('active');
            }
        }

        tabBtns.forEach(btn => {
            btn.addEventListener('click', () => {
                switchTab(btn.getAttribute('data-tab'));
            });
        });

        // Handle initial tab from URL parameters
        const urlParams = new URLSearchParams(window.location.search);
        const initialTab = urlParams.get('tab');
        if (initialTab) {
            switchTab(initialTab + '-tab');
        }

        // Toggle Add Product Form
        const btnToggleAddProduct = document.getElementById('btnToggleAddProduct');
        const addProductSection = document.getElementById('addProductSection');

        if (btnToggleAddProduct && addProductSection) {
            btnToggleAddProduct.addEventListener('click', () => {
                if (addProductSection.style.display === 'none') {
                    addProductSection.style.display = 'block';
                    btnToggleAddProduct.textContent = 'â– éš±è—æ–°å¢å•†å“';
                } else {
                    addProductSection.style.display = 'none';
                    btnToggleAddProduct.textContent = 'â• æ–°å¢å•†å“';
                }
            });
        }

        // Select All for Products
        var selectAll = document.getElementById('select-all');
        var checkboxes = document.querySelectorAll('.product-id-checkbox');
        if (selectAll && checkboxes.length) {
            selectAll.addEventListener('change', function () {
                checkboxes.forEach(function (cb) { cb.checked = selectAll.checked; });
            });
            checkboxes.forEach(function (cb) {
                cb.addEventListener('change', function () {
                    var allChecked = Array.from(checkboxes).every(function (c) { return c.checked; });
                    var someChecked = Array.from(checkboxes).some(function (c) { return c.checked; });
                    selectAll.checked = allChecked;
                    selectAll.indeterminate = someChecked && !allChecked;
                });
            });
        }
        window.confirmBatchDelete = function (form) {
            var checked = form.querySelectorAll('input[name="product_ids"]:checked');
            if (checked.length === 0) {
                alert('è«‹å…ˆå‹¾é¸è¦åˆªé™¤çš„å•†å“');
                return false;
            }
            return confirm('ç¢ºå®šè¦åˆªé™¤æ‰€é¸çš„ ' + checked.length + ' é …å•†å“å—ï¼Ÿ');
        };

        window.confirmDiaryBatchDelete = function (form) {
            var checked = form.querySelectorAll('input[name="diary_ids"]:checked');
            if (checked.length === 0) {
                alert('è«‹å…ˆå‹¾é¸è¦åˆªé™¤çš„æ—¥è¨˜');
                return false;
            }
            return confirm('ç¢ºå®šè¦åˆªé™¤æ‰€é¸çš„ ' + checked.length + ' å‰‡æ—¥è¨˜å—ï¼Ÿ');
        };
    })();
</script>
{% endblock %}