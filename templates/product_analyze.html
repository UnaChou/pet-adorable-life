{% extends "base.html" %}

{% block title %}å•†å“åˆ†æ - Pet Adorable Life{% endblock %}

{% block content %}
<nav class="nav-bar">
    <a href="/" class="logo">Pet Adorable Life</a>
    <ul class="nav-links">
        <li><a href="/">é¦–é </a></li>
        <li><a href="/product/analyze">å•†å“åˆ†æ</a></li>
        <li><a href="/organize">è³‡è¨Šæ•´ç†</a></li>
        <li><a href="/diary">å¯µç‰©æ—¥è¨˜</a></li>
    </ul>
</nav>

<main class="analyze-page">
    <section class="analyze-hero">
        <h1>å•†å“åˆ†æ</h1>
        <p>ä¸Šå‚³å¯µç‰©å•†å“åœ–ç‰‡ï¼ŒAI æœƒè‡ªå‹•æ“·å–æ¨™é¡Œèˆ‡æ‘˜è¦</p>
    </section>

    <section class="analyze-upload">
        <div class="upload-zone" id="uploadZone">
            <input type="file" id="fileInput" accept="image/png,image/jpeg,image/jpg,image/webp,image/gif" hidden>
            <div class="upload-placeholder" id="uploadPlaceholder">
                <span class="upload-icon">ğŸ“·</span>
                <p>é»æ“Šæˆ–æ‹–æ›³åœ–ç‰‡åˆ°æ­¤è™•</p>
                <p class="upload-hint">æ”¯æ´ PNGã€JPGã€WebPã€GIF</p>
            </div>
            <div class="upload-preview" id="uploadPreview" style="display: none;">
                <img id="previewImg" src="" alt="é è¦½">
            </div>
        </div>
        <button type="button" class="btn-analyze" id="btnAnalyze" disabled>é–‹å§‹åˆ†æ</button>
    </section>

    <section class="analyze-result" id="resultSection" style="display: none;">
        <h2>åˆ†æçµæœ <span class="edit-hint">ï¼ˆå¯ç·¨ä¿®å¾Œå„²å­˜ï¼‰</span></h2>
        <form action="/organize/add" method="post" class="result-edit-form add-form" id="resultForm">
            <div class="result-card">
                <div class="form-group">
                    <label for="resultTitle">å•†å“åç¨±</label>
                    <input type="text" id="resultTitle" name="title" class="result-title-input" placeholder="å•†å“æ¨™é¡Œ" maxlength="500">
                </div>
                <div class="form-group">
                    <label for="resultSummary">å•†å“æ‘˜è¦</label>
                    <textarea id="resultSummary" name="summary" class="result-summary-input" rows="6" placeholder="å•†å“æè¿°ã€ç‰¹è‰²è¦é»..."></textarea>
                </div>
                <button type="submit" class="btn-add-to-organize">ğŸ’¾ å„²å­˜ä¸¦åŠ å…¥è³‡è¨Šæ•´ç†</button>
            </div>
        </form>
    </section>

    <section class="analyze-error" id="errorSection" style="display: none;">
        <p class="error-msg" id="errorMsg"></p>
    </section>

    <section class="analyze-debug" id="debugSection" style="display: none;">
        <h3>æ¥æ”¶å›å‚³çš„ data</h3>
        <pre class="debug-raw" id="debugRaw"></pre>
    </section>

    <div class="loading" id="loading" style="display: none;">
        <div class="spinner"></div>
        <p>AI åˆ†æä¸­...</p>
    </div>
</main>

<script>
(function() {
    const uploadZone = document.getElementById('uploadZone');
    const fileInput = document.getElementById('fileInput');
    const uploadPlaceholder = document.getElementById('uploadPlaceholder');
    const uploadPreview = document.getElementById('uploadPreview');
    const previewImg = document.getElementById('previewImg');
    const btnAnalyze = document.getElementById('btnAnalyze');
    const resultSection = document.getElementById('resultSection');
    const resultTitleInput = document.getElementById('resultTitle');
    const resultSummaryInput = document.getElementById('resultSummary');
    const errorSection = document.getElementById('errorSection');
    const errorMsg = document.getElementById('errorMsg');
    const loading = document.getElementById('loading');
    const debugSection = document.getElementById('debugSection');
    const debugRaw = document.getElementById('debugRaw');

    let selectedFile = null;

    uploadZone.addEventListener('click', () => fileInput.click());
    uploadZone.addEventListener('dragover', (e) => {
        e.preventDefault();
        uploadZone.classList.add('drag-over');
    });
    uploadZone.addEventListener('dragleave', () => uploadZone.classList.remove('drag-over'));
    uploadZone.addEventListener('drop', (e) => {
        e.preventDefault();
        uploadZone.classList.remove('drag-over');
        const file = e.dataTransfer.files[0];
        if (file && file.type.startsWith('image/')) handleFile(file);
    });
    fileInput.addEventListener('change', (e) => {
        const file = e.target.files[0];
        if (file) handleFile(file);
    });

    function handleFile(file) {
        selectedFile = file;
        previewImg.src = URL.createObjectURL(file);
        uploadPlaceholder.style.display = 'none';
        uploadPreview.style.display = 'block';
        btnAnalyze.disabled = false;
        resultSection.style.display = 'none';
        errorSection.style.display = 'none';
    }

    btnAnalyze.addEventListener('click', async () => {
        if (!selectedFile) return;
        loading.style.display = 'flex';
        resultSection.style.display = 'none';
        errorSection.style.display = 'none';
        debugSection.style.display = 'none';

        const formData = new FormData();
        formData.append('image', selectedFile);

        let rawText = '';
        try {
            rawText = await (await fetch('/api/product/analyze', { method: 'POST', body: formData })).text();
        } catch (err) {
            debugRaw.textContent = 'ç¶²è·¯éŒ¯èª¤: ' + err.message;
            debugSection.style.display = 'block';
            errorMsg.textContent = err.message;
            errorSection.style.display = 'block';
            loading.style.display = 'none';
            return;
        }

        let data;
        try {
            data = JSON.parse(rawText);
        } catch (e) {
            debugRaw.textContent = 'JSON è§£æå¤±æ•— (line 1 column 1)\n\nåŸå§‹å›å‚³:\n' + rawText;
            debugSection.style.display = 'block';
            errorMsg.textContent = 'ä¼ºæœå™¨å›å‚³é JSONï¼Œè«‹æŸ¥çœ‹ä¸‹æ–¹ã€Œæ¥æ”¶å›å‚³çš„ dataã€';
            errorSection.style.display = 'block';
            loading.style.display = 'none';
            return;
        }

        // æ°¸é é¡¯ç¤ºæ¥æ”¶åˆ°çš„å®Œæ•´ data
        debugRaw.textContent = JSON.stringify(data, null, 2);
        debugSection.style.display = 'block';

        if (!data || data.error) {
            errorMsg.textContent = data?.error || 'åˆ†æå¤±æ•—';
            errorSection.style.display = 'block';
        } else {
            resultTitleInput.value = data.title || '(ç„¡æ¨™é¡Œ)';
            resultSummaryInput.value = data.summary || '';
            resultSection.style.display = 'block';
        }
        loading.style.display = 'none';
    });
})();
</script>
{% endblock %}
