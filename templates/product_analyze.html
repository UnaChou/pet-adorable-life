{% extends "base.html" %}

{% block title %}å•†å“åˆ†æ - Pet Adorable Life{% endblock %}

{% block content %}
<nav class="nav-bar">
    <a href="/" class="logo">Pet Adorable Life</a>
    <ul class="nav-links">
        <li><a href="/">é¦–é </a></li>
        <li><a href="/product/analyze">å•†å“åˆ†æ</a></li>
        <li><a href="/organize">Pet Life</a></li>
        <li><a href="/diary">å¯µç‰©æ—¥è¨˜</a></li>
    </ul>
</nav>

<main class="analyze-page">
    <section class="analyze-hero">
        <h1>å•†å“åˆ†æ</h1>
        <p>ä¸Šå‚³å¯µç‰©å•†å“åœ–ç‰‡ï¼ŒAI æœƒè‡ªå‹•æ“·å–æ¨™é¡Œèˆ‡æ‘˜è¦</p>
    </section>

    <section class="analyze-upload">
        <div class="camera-header-actions">
            <button type="button" class="btn-camera" id="btnCamera">ğŸ“· é–‹å•Ÿç›¸æ©Ÿ</button>
        </div>
        <div class="upload-container">
            <div class="upload-zone" id="uploadZone">
                <input type="file" id="fileInput" accept="image/png,image/jpeg,image/jpg,image/webp,image/gif" hidden>
                <div class="upload-placeholder" id="uploadPlaceholder">
                    <span class="upload-icon">ğŸ“·</span>
                    <p>é»æ“Šæˆ–æ‹–æ›³åœ–ç‰‡åˆ°æ­¤è™•</p>
                    <p class="upload-hint">æ”¯æ´ PNGã€JPGã€WebPã€GIF</p>
                </div>
                <div class="upload-preview" id="uploadPreview" style="display: none;">
                    <img id="previewImg" src="" alt="é è¦½">
                    <video id="cameraVideo" autoplay playsinline style="display: none;"></video>
                    <canvas id="cameraCanvas" style="display: none;"></canvas>
                </div>
            </div>
            <div class="camera-controls">
                <button type="button" class="btn-cancel-camera" id="btnCancelCamera" style="display: none;">âœ•
                    å–æ¶ˆ</button>
                <button type="button" class="btn-capture" id="btnCapture" style="display: none;">ğŸ“¸ æ‹ç…§</button>
            </div>
        </div>
        <button type="button" class="btn-analyze" id="btnAnalyze" disabled>é–‹å§‹åˆ†æ</button>
    </section>

    <section class="analyze-result" id="resultSection" style="display: none;">
        <h2>åˆ†æçµæœ <span class="edit-hint">ï¼ˆå¯ç·¨ä¿®å¾Œå„²å­˜ï¼‰</span></h2>
        <form action="/organize/add" method="post" class="result-edit-form add-form" id="resultForm">
            <div class="result-card">
                <div class="form-group">
                    <label for="resultTitle">å•†å“åç¨±</label>
                    <input type="text" id="resultTitle" name="title" class="result-title-input" placeholder="å•†å“æ¨™é¡Œ"
                        maxlength="500">
                </div>
                <div class="form-group">
                    <label for="resultSummary">å•†å“æ‘˜è¦</label>
                    <textarea id="resultSummary" name="summary" class="result-summary-input" rows="6"
                        placeholder="å•†å“æè¿°ã€ç‰¹è‰²è¦é»..."></textarea>
                </div>
                <button type="submit" class="btn-add-to-organize">ğŸ’¾ å„²å­˜ä¸¦åŠ å…¥Pet Life</button>
            </div>
        </form>
    </section>

    <section class="analyze-error" id="errorSection" style="display: none;">
        <p class="error-msg" id="errorMsg"></p>
    </section>

    <section class="analyze-debug" id="debugSection" style="display: none;">
        <h3>æ¥æ”¶å›å‚³çš„ data</h3>
        <pre class="debug-raw" id="debugRaw"></pre>
    </section>

    <div class="loading" id="loading" style="display: none;">
        <div class="spinner"></div>
        <p>AI åˆ†æä¸­...</p>
    </div>
</main>

<script>
    (function () {
        const uploadZone = document.getElementById('uploadZone');
        const fileInput = document.getElementById('fileInput');
        const btnCamera = document.getElementById('btnCamera');
        const uploadPlaceholder = document.getElementById('uploadPlaceholder');
        const uploadPreview = document.getElementById('uploadPreview');
        const previewImg = document.getElementById('previewImg');
        const cameraVideo = document.getElementById('cameraVideo');
        const cameraCanvas = document.getElementById('cameraCanvas');
        const btnCapture = document.getElementById('btnCapture');
        const btnCancelCamera = document.getElementById('btnCancelCamera');
        const btnAnalyze = document.getElementById('btnAnalyze');
        const resultSection = document.getElementById('resultSection');
        const resultTitleInput = document.getElementById('resultTitle');
        const resultSummaryInput = document.getElementById('resultSummary');
        const errorSection = document.getElementById('errorSection');
        const errorMsg = document.getElementById('errorMsg');
        const loading = document.getElementById('loading');
        const debugSection = document.getElementById('debugSection');
        const debugRaw = document.getElementById('debugRaw');

        let selectedFile = null;
        let mediaStream = null;

        btnCamera.addEventListener('click', async (e) => {
            e.preventDefault();
            e.stopPropagation();
            try {
                mediaStream = await navigator.mediaDevices.getUserMedia({
                    video: { facingMode: 'environment' },
                    audio: false
                });
                cameraVideo.srcObject = mediaStream;
                cameraVideo.style.display = 'block';
                previewImg.style.display = 'none';
                uploadPlaceholder.style.display = 'none';
                uploadPreview.style.display = 'block';
                btnCapture.style.display = 'block';
                btnCancelCamera.style.display = 'block';
                btnAnalyze.disabled = true;
            } catch (err) {
                console.error('Error accessing camera:', err);
                alert('ç„¡æ³•é–‹å•Ÿç›¸æ©Ÿï¼Œè«‹ç¢ºä¿å·²æˆæ¬Šç›¸æ©Ÿæ¬Šé™');
            }
        });

        btnCapture.addEventListener('click', (e) => {
            e.stopPropagation();
            const context = cameraCanvas.getContext('2d');
            cameraCanvas.width = cameraVideo.videoWidth;
            cameraCanvas.height = cameraVideo.videoHeight;
            context.drawImage(cameraVideo, 0, 0, cameraCanvas.width, cameraCanvas.height);

            cameraCanvas.toBlob((blob) => {
                selectedFile = new File([blob], 'camera_capture.jpg', { type: 'image/jpeg' });
                previewImg.src = URL.createObjectURL(blob);
                previewImg.style.display = 'block';
                cameraVideo.style.display = 'none';
                btnCapture.style.display = 'none';
                btnCancelCamera.style.display = 'none';
                uploadPlaceholder.style.display = 'none';
                uploadPreview.style.display = 'block';

                if (mediaStream) {
                    mediaStream.getTracks().forEach(track => track.stop());
                    mediaStream = null;
                }

                btnAnalyze.disabled = false;
                resultSection.style.display = 'none';
                errorSection.style.display = 'none';

                handleFile(selectedFile);
            }, 'image/jpeg', 0.9);
        });

        btnCancelCamera.addEventListener('click', (e) => {
            e.stopPropagation();
            if (mediaStream) {
                mediaStream.getTracks().forEach(track => track.stop());
                mediaStream = null;
            }
            cameraVideo.style.display = 'none';
            btnCapture.style.display = 'none';
            btnCancelCamera.style.display = 'none';
            if (selectedFile) {
                previewImg.style.display = 'block';
            } else {
                uploadPlaceholder.style.display = 'block';
                uploadPreview.style.display = 'none';
            }
        });

        uploadZone.addEventListener('click', (e) => {
            if (e.target === btnCapture || e.target === btnCancelCamera) return;
            fileInput.click();
        });
        uploadZone.addEventListener('dragover', (e) => {
            e.preventDefault();
            uploadZone.classList.add('drag-over');
        });
        uploadZone.addEventListener('dragleave', () => uploadZone.classList.remove('drag-over'));
        uploadZone.addEventListener('drop', (e) => {
            e.preventDefault();
            uploadZone.classList.remove('drag-over');
            const file = e.dataTransfer.files[0];
            if (file && file.type.startsWith('image/')) handleFile(file);
        });
        fileInput.addEventListener('change', (e) => {
            const file = e.target.files[0];
            if (file) handleFile(file);
        });

        function handleFile(file) {
            selectedFile = file;
            previewImg.src = URL.createObjectURL(file);
            uploadPlaceholder.style.display = 'none';
            uploadPreview.style.display = 'block';
            btnAnalyze.disabled = false;
            resultSection.style.display = 'none';
            errorSection.style.display = 'none';
        }

        btnAnalyze.addEventListener('click', async () => {
            if (!selectedFile) return;
            loading.style.display = 'flex';
            resultSection.style.display = 'none';
            errorSection.style.display = 'none';
            debugSection.style.display = 'none';

            const formData = new FormData();
            formData.append('image', selectedFile);

            let rawText = '';
            let success = false;
            let attempts = 0;
            const maxAttempts = 3;

            while (!success && attempts < maxAttempts) {
                attempts++;
                try {
                    const response = await fetch('/api/product/analyze', { method: 'POST', body: formData });
                    rawText = await response.text();
                    if (response.ok) {
                        success = true;
                    } else if (attempts < maxAttempts) {
                        console.log(`Attempt ${attempts} failed, retrying...`);
                    }
                } catch (err) {
                    if (attempts >= maxAttempts) {
                        debugRaw.textContent = 'ç¶²è·¯éŒ¯èª¤: ' + err.message;
                        debugSection.style.display = 'block';
                        errorMsg.textContent = err.message;
                        errorSection.style.display = 'block';
                        loading.style.display = 'none';
                        return;
                    }
                    console.log(`Attempt ${attempts} network error, retrying...`);
                }
            }

            let data;
            try {
                data = JSON.parse(rawText);
            } catch (e) {
                debugRaw.textContent = 'JSON è§£æå¤±æ•— (line 1 column 1)\n\nåŸå§‹å›å‚³:\n' + rawText;
                debugSection.style.display = 'block';
                errorMsg.textContent = 'ä¼ºæœå™¨å›å‚³é JSONï¼Œè«‹æŸ¥çœ‹ä¸‹æ–¹ã€Œæ¥æ”¶å›å‚³çš„ dataã€';
                errorSection.style.display = 'block';
                loading.style.display = 'none';
                return;
            }

            // æ°¸é é¡¯ç¤ºæ¥æ”¶åˆ°çš„å®Œæ•´ data
            debugRaw.textContent = JSON.stringify(data, null, 2);
            debugSection.style.display = 'block';

            if (!data || data.error) {
                errorMsg.textContent = data?.error || 'åˆ†æå¤±æ•—';
                errorSection.style.display = 'block';
            } else {
                resultTitleInput.value = data.title || '(ç„¡æ¨™é¡Œ)';
                resultSummaryInput.value = data.summary || '';
                resultSection.style.display = 'block';
            }
            loading.style.display = 'none';
        });
    })();
</script>
{% endblock %}