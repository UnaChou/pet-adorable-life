{% extends "base.html" %}

{% block title %}å¯µç‰©æ—¥è¨˜ - Pet Adorable Life{% endblock %}

{% block content %}
<nav class="nav-bar">
    <a href="/" class="logo">Pet Adorable Life</a>
    <ul class="nav-links">
        <li><a href="/">é¦–é </a></li>
        <li><a href="/product/analyze">å•†å“åˆ†æ</a></li>
        <li><a href="/organize">Pet Life</a></li>
        <li><a href="/diary" class="active">å¯µç‰©æ—¥è¨˜</a></li>
    </ul>
</nav>

<main class="diary-page">
    <section class="diary-hero">
        <h1>ğŸ“” å¯µç‰©æ—¥è¨˜</h1>
        <p>ä¸Šå‚³æ¯›å­©ç…§ç‰‡ï¼ŒAI åˆ†æå¿ƒæƒ…èˆ‡æƒ…ç·’ï¼Œè¨˜éŒ„å°ˆå±¬æ—¥è¨˜</p>
    </section>

    <section class="diary-new">
        <h2>æ–°å¢æ—¥è¨˜</h2>
        <div class="diary-upload">
            <div class="camera-header-actions">
                <button type="button" class="btn-camera" id="btnCamera">ğŸ“· é–‹å•Ÿç›¸æ©Ÿ</button>
            </div>
            <div class="upload-container">
                <div class="upload-zone" id="uploadZone">
                    <input type="file" id="fileInput" accept="image/png,image/jpeg,image/jpg,image/webp,image/gif"
                        hidden>
                    <div class="upload-placeholder" id="uploadPlaceholder">
                        <span class="upload-icon">ğŸ“·</span>
                        <p>é»æ“Šæˆ–æ‹–æ›³åœ–ç‰‡åˆ°æ­¤è™•</p>
                        <p class="upload-hint">æ”¯æ´ PNGã€JPGã€WebPã€GIF</p>
                    </div>
                    <div class="upload-preview" id="uploadPreview" style="display: none;">
                        <img id="previewImg" src="" alt="é è¦½">
                        <video id="cameraVideo" autoplay playsinline style="display: none;"></video>
                        <canvas id="cameraCanvas" style="display: none;"></canvas>
                    </div>
                </div>
                <div class="camera-controls">
                    <button type="button" class="btn-cancel-camera" id="btnCancelCamera" style="display: none;">âœ•
                        å–æ¶ˆ</button>
                    <button type="button" class="btn-capture" id="btnCapture" style="display: none;">ğŸ“¸ æ‹ç…§</button>
                </div>
            </div>
            <button type="button" class="btn-analyze" id="btnAnalyze" disabled>AI åˆ†æ</button>
        </div>

        <section class="diary-result" id="resultSection" style="display: none;">
            <h3>åˆ†æçµæœ <span class="edit-hint">ï¼ˆå¯ç·¨ä¿®å¾Œå„²å­˜ï¼‰</span></h3>
            <form action="{{ url_for('diary_save') }}" method="post" class="diary-edit-form">
                <input type="hidden" name="image_base64" id="imageBase64">
                <div class="diary-form-card">
                    <div class="form-group">
                        <label for="diaryTitle">æ¨™é¡Œ</label>
                        <input type="text" id="diaryTitle" name="title" placeholder="æ—¥è¨˜æ¨™é¡Œ">
                    </div>
                    <div class="form-group">
                        <label for="describeText">å¿ƒæƒ…æè¿°</label>
                        <textarea id="describeText" name="describe_text" rows="5"
                            placeholder="AI åˆ†æçš„å¿ƒæƒ…èˆ‡æƒ…ç·’æè¿°..."></textarea>
                    </div>
                    <div class="form-group">
                        <label for="mainEmotion">ä¸»è¦æƒ…ç·’</label>
                        <input type="text" id="mainEmotion" name="main_emotion" placeholder="ä¾‹å¦‚ï¼šé–‹å¿ƒã€æ…µæ‡¶ã€å¥½å¥‡">
                    </div>
                    <div class="form-group">
                        <label for="diaryMemo">å‚™è¨»ï¼ˆMemoï¼‰</label>
                        <textarea id="diaryMemo" name="memo" rows="4" placeholder="å¯«ä¸‹ä»Šæ—¥æƒ³è¨˜éŒ„çš„é»æ»´..."></textarea>
                    </div>
                    <button type="submit" class="btn-save">ğŸ’¾ å„²å­˜</button>
                </div>
            </form>
        </section>

        <section class="diary-error" id="errorSection" style="display: none;">
            <p class="error-msg" id="errorMsg"></p>
        </section>

        <div class="loading" id="loading" style="display: none;">
            <div class="spinner"></div>
            <p>AI åˆ†æä¸­...</p>
        </div>
    </section>


</main>

<script>
    (function () {
        const uploadZone = document.getElementById('uploadZone');
        const fileInput = document.getElementById('fileInput');
        const btnCamera = document.getElementById('btnCamera');
        const uploadPlaceholder = document.getElementById('uploadPlaceholder');
        const uploadPreview = document.getElementById('uploadPreview');
        const previewImg = document.getElementById('previewImg');
        const cameraVideo = document.getElementById('cameraVideo');
        const cameraCanvas = document.getElementById('cameraCanvas');
        const btnCapture = document.getElementById('btnCapture');
        const btnCancelCamera = document.getElementById('btnCancelCamera');
        const btnAnalyze = document.getElementById('btnAnalyze');
        const resultSection = document.getElementById('resultSection');
        const diaryTitle = document.getElementById('diaryTitle');
        const describeText = document.getElementById('describeText');
        const mainEmotion = document.getElementById('mainEmotion');
        const diaryMemo = document.getElementById('diaryMemo');
        const imageBase64Input = document.getElementById('imageBase64');
        const errorSection = document.getElementById('errorSection');
        const errorMsg = document.getElementById('errorMsg');
        const loading = document.getElementById('loading');

        let selectedFile = null;
        let mediaStream = null;

        if (!uploadZone) return;

        btnCamera.addEventListener('click', async (e) => {
            e.preventDefault();
            e.stopPropagation();
            try {
                mediaStream = await navigator.mediaDevices.getUserMedia({
                    video: { facingMode: 'environment' },
                    audio: false
                });
                cameraVideo.srcObject = mediaStream;
                cameraVideo.style.display = 'block';
                previewImg.style.display = 'none';
                uploadPlaceholder.style.display = 'none';
                uploadPreview.style.display = 'block';
                btnCapture.style.display = 'block';
                btnCancelCamera.style.display = 'block';
                btnAnalyze.disabled = true;
            } catch (err) {
                console.error('Error accessing camera:', err);
                alert('ç„¡æ³•é–‹å•Ÿç›¸æ©Ÿï¼Œè«‹ç¢ºä¿å·²æˆæ¬Šç›¸æ©Ÿæ¬Šé™');
            }
        });

        btnCapture.addEventListener('click', (e) => {
            e.stopPropagation();
            const context = cameraCanvas.getContext('2d');
            cameraCanvas.width = cameraVideo.videoWidth;
            cameraCanvas.height = cameraVideo.videoHeight;
            context.drawImage(cameraVideo, 0, 0, cameraCanvas.width, cameraCanvas.height);

            cameraCanvas.toBlob((blob) => {
                selectedFile = new File([blob], 'camera_capture.jpg', { type: 'image/jpeg' });
                previewImg.src = URL.createObjectURL(blob);
                previewImg.style.display = 'block';
                cameraVideo.style.display = 'none';
                btnCapture.style.display = 'none';
                btnCancelCamera.style.display = 'none';
                uploadPlaceholder.style.display = 'none';
                uploadPreview.style.display = 'block';

                if (mediaStream) {
                    mediaStream.getTracks().forEach(track => track.stop());
                    mediaStream = null;
                }

                btnAnalyze.disabled = false;
                resultSection.style.display = 'none';
                errorSection.style.display = 'none';

                compressImage(selectedFile, 200).then(base64 => {
                    imageBase64Input.value = base64;
                }).catch(err => {
                    console.error('Image compression failed:', err);
                });
            }, 'image/jpeg', 0.9);
        });

        btnCancelCamera.addEventListener('click', (e) => {
            e.stopPropagation();
            stopCamera();
        });

        function stopCamera() {
            if (mediaStream) {
                mediaStream.getTracks().forEach(track => track.stop());
                mediaStream = null;
            }
            cameraVideo.style.display = 'none';
            btnCapture.style.display = 'none';
            btnCancelCamera.style.display = 'none';
            if (selectedFile) {
                previewImg.style.display = 'block';
            } else {
                uploadPlaceholder.style.display = 'block';
                uploadPreview.style.display = 'none';
            }
        }

        uploadZone.addEventListener('click', (e) => {
            if (e.target === btnCapture || e.target === btnCancelCamera) return;
            fileInput.click();
        });
        uploadZone.addEventListener('dragover', (e) => {
            e.preventDefault();
            uploadZone.classList.add('drag-over');
        });
        uploadZone.addEventListener('dragleave', () => uploadZone.classList.remove('drag-over'));
        uploadZone.addEventListener('drop', (e) => {
            e.preventDefault();
            uploadZone.classList.remove('drag-over');
            const file = e.dataTransfer.files[0];
            if (file && file.type.startsWith('image/')) handleFile(file);
        });
        fileInput.addEventListener('change', (e) => {
            const file = e.target.files[0];
            if (file) handleFile(file);
        });

        function handleFile(file) {
            selectedFile = file;
            previewImg.src = URL.createObjectURL(file);
            uploadPlaceholder.style.display = 'none';
            uploadPreview.style.display = 'block';
            btnAnalyze.disabled = false;
            resultSection.style.display = 'none';
            errorSection.style.display = 'none';

            compressImage(file, 200).then(base64 => {
                imageBase64Input.value = base64;
            }).catch(err => {
                console.error('Image compression failed:', err);
            });
        }

        function compressImage(file, maxSizeKB) {
            return new Promise((resolve, reject) => {
                const reader = new FileReader();
                reader.readAsDataURL(file);
                reader.onload = function (event) {
                    const img = new Image();
                    img.src = event.target.result;
                    img.onload = function () {
                        let canvas = document.createElement('canvas');
                        let ctx = canvas.getContext('2d');

                        let width = img.width;
                        let height = img.height;

                        // Initial scale down if image is huge (e.g., > 1200px)
                        const MAX_DIMENSION = 1200;
                        if (width > MAX_DIMENSION || height > MAX_DIMENSION) {
                            const ratio = Math.min(MAX_DIMENSION / width, MAX_DIMENSION / height);
                            width *= ratio;
                            height *= ratio;
                        }

                        canvas.width = width;
                        canvas.height = height;
                        ctx.drawImage(img, 0, 0, width, height);

                        let quality = 0.9;
                        let dataUrl = canvas.toDataURL('image/jpeg', quality);

                        // Rough size estimation of base64: length * (3/4)
                        let currentSize = Math.round((dataUrl.length * 3) / 4);

                        function doCompress() {
                            const maxSizeByte = maxSizeKB * 1024;
                            if (currentSize <= maxSizeByte || quality <= 0.1) {
                                resolve(dataUrl);
                                return;
                            }

                            quality -= 0.1;
                            dataUrl = canvas.toDataURL('image/jpeg', quality);
                            currentSize = Math.round((dataUrl.length * 3) / 4);

                            // If still too big even at lowest quality, scale down resolution
                            if (quality <= 0.1 && currentSize > maxSizeByte) {
                                width *= 0.8;
                                height *= 0.8;
                                canvas.width = width;
                                canvas.height = height;
                                ctx.drawImage(img, 0, 0, width, height);
                                quality = 0.5; // Reset quality for new resolution
                            }

                            doCompress();
                        }

                        doCompress();
                    };
                    img.onerror = reject;
                };
                reader.onerror = reject;
            });
        }

        btnAnalyze.addEventListener('click', async () => {
            if (!selectedFile) return;
            loading.style.display = 'flex';
            resultSection.style.display = 'none';
            errorSection.style.display = 'none';

            const formData = new FormData();
            formData.append('image', selectedFile);

            let res;
            let rawText = '';
            let success = false;
            let attempts = 0;
            const maxAttempts = 3;

            while (!success && attempts < maxAttempts) {
                attempts++;
                try {
                    res = await fetch('/api/diary/analyze', { method: 'POST', body: formData });
                    rawText = await res.text();
                    if (res.ok) {
                        success = true;
                    } else if (attempts < maxAttempts) {
                        console.log(`Attempt ${attempts} failed, retrying...`);
                    }
                } catch (err) {
                    if (attempts >= maxAttempts) {
                        errorMsg.textContent = err.message || 'ç¶²è·¯éŒ¯èª¤';
                        errorSection.style.display = 'block';
                        loading.style.display = 'none';
                        return;
                    }
                    console.log(`Attempt ${attempts} network error, retrying...`);
                }
            }

            try {
                let data;
                try {
                    data = rawText ? JSON.parse(rawText) : {};
                } catch (e) {
                    errorMsg.textContent = 'ä¼ºæœå™¨å›å‚³é JSONã€‚' + (res && res.status !== 200 ? 'ç‹€æ…‹ç¢¼ï¼š' + res.status : '') + ' è«‹ç¢ºèª Ollama æœå‹™æ˜¯å¦é‹è¡Œã€‚';
                    errorSection.style.display = 'block';
                    loading.style.display = 'none';
                    return;
                }
                if (!res || res.status !== 200 || data.error) {
                    errorMsg.textContent = data.error || 'åˆ†æå¤±æ•—';
                    errorSection.style.display = 'block';
                } else {
                    diaryTitle.value = data.title || '';
                    describeText.value = data.describe || '';
                    mainEmotion.value = data.main_emotion || '';
                    diaryMemo.value = '';
                    resultSection.style.display = 'block';
                }
            } catch (err) {
                errorMsg.textContent = err.message || 'ç™¼ç”ŸæœªçŸ¥çš„éŒ¯èª¤';
                errorSection.style.display = 'block';
            }
            loading.style.display = 'none';
        });
    })();
</script>
{% endblock %}