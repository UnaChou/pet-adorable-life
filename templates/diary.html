{% extends "base.html" %}

{% block title %}å¯µç‰©æ—¥è¨˜ - Pet Adorable Life{% endblock %}

{% block content %}
<nav class="nav-bar">
    <a href="/" class="logo">Pet Adorable Life</a>
    <ul class="nav-links">
        <li><a href="/">é¦–é </a></li>
        <li><a href="/product/analyze">å•†å“åˆ†æ</a></li>
        <li><a href="/organize">è³‡è¨Šæ•´ç†</a></li>
        <li><a href="/diary" class="active">å¯µç‰©æ—¥è¨˜</a></li>
    </ul>
</nav>

<main class="diary-page">
    <section class="diary-hero">
        <h1>ğŸ“” å¯µç‰©æ—¥è¨˜</h1>
        <p>ä¸Šå‚³æ¯›å­©ç…§ç‰‡ï¼ŒAI åˆ†æå¿ƒæƒ…èˆ‡æƒ…ç·’ï¼Œè¨˜éŒ„å°ˆå±¬æ—¥è¨˜</p>
    </section>

    <section class="diary-new">
        <h2>æ–°å¢æ—¥è¨˜</h2>
        <div class="diary-upload">
            <div class="upload-zone" id="uploadZone">
                <input type="file" id="fileInput" accept="image/png,image/jpeg,image/jpg,image/webp,image/gif" hidden>
                <div class="upload-placeholder" id="uploadPlaceholder">
                    <span class="upload-icon">ğŸ“·</span>
                    <p>é»æ“Šæˆ–æ‹–æ›³åœ–ç‰‡åˆ°æ­¤è™•</p>
                    <p class="upload-hint">æ”¯æ´ PNGã€JPGã€WebPã€GIF</p>
                </div>
                <div class="upload-preview" id="uploadPreview" style="display: none;">
                    <img id="previewImg" src="" alt="é è¦½">
                </div>
            </div>
            <button type="button" class="btn-analyze" id="btnAnalyze" disabled>AI åˆ†æ</button>
        </div>

        <section class="diary-result" id="resultSection" style="display: none;">
            <h3>åˆ†æçµæœ <span class="edit-hint">ï¼ˆå¯ç·¨ä¿®å¾Œå„²å­˜ï¼‰</span></h3>
            <form action="{{ url_for('diary_save') }}" method="post" class="diary-edit-form">
                <div class="diary-form-card">
                    <div class="form-group">
                        <label for="diaryTitle">æ¨™é¡Œ</label>
                        <input type="text" id="diaryTitle" name="title" placeholder="æ—¥è¨˜æ¨™é¡Œ">
                    </div>
                    <div class="form-group">
                        <label for="describeText">å¿ƒæƒ…æè¿°</label>
                        <textarea id="describeText" name="describe_text" rows="5" placeholder="AI åˆ†æçš„å¿ƒæƒ…èˆ‡æƒ…ç·’æè¿°..."></textarea>
                    </div>
                    <div class="form-group">
                        <label for="mainEmotion">ä¸»è¦æƒ…ç·’</label>
                        <input type="text" id="mainEmotion" name="main_emotion" placeholder="ä¾‹å¦‚ï¼šé–‹å¿ƒã€æ…µæ‡¶ã€å¥½å¥‡">
                    </div>
                    <div class="form-group">
                        <label for="diaryMemo">å‚™è¨»ï¼ˆMemoï¼‰</label>
                        <textarea id="diaryMemo" name="memo" rows="4" placeholder="å¯«ä¸‹ä»Šæ—¥æƒ³è¨˜éŒ„çš„é»æ»´..."></textarea>
                    </div>
                    <button type="submit" class="btn-save">ğŸ’¾ å„²å­˜</button>
                </div>
            </form>
        </section>

        <section class="diary-error" id="errorSection" style="display: none;">
            <p class="error-msg" id="errorMsg"></p>
        </section>

        <div class="loading" id="loading" style="display: none;">
            <div class="spinner"></div>
            <p>AI åˆ†æä¸­...</p>
        </div>
    </section>

    <section class="diary-list">
        <div class="list-header">
            <h2>æ—¥è¨˜åˆ—è¡¨ <span class="count">å…± {{ diaries|length }} å‰‡</span></h2>
        </div>

        {% if diaries %}
        <div class="diary-cards">
            {% for d in diaries %}
            <article class="diary-card">
                <div class="diary-card-body">
                    <div class="diary-meta">
                        <span class="diary-id">#{{ d.id }}</span>
                        <span class="diary-dates">
                            {{ d.created_at.strftime('%Y-%m-%d %H:%M') if d.created_at else '-' }}
                        </span>
                    </div>
                    {% if d.title %}
                    <h4 class="diary-title">{{ d.title }}</h4>
                    {% endif %}
                    <div class="diary-emotion">{{ d.main_emotion }}</div>
                    <div class="diary-describe">{{ d.describe_text|replace('\n', '<br>')|safe }}</div>
                    {% if d.memo %}
                    <div class="diary-memo">
                        <strong>å‚™è¨»ï¼š</strong>{{ d.memo|replace('\n', '<br>')|safe }}
                    </div>
                    {% endif %}
                </div>
                <div class="diary-card-actions">
                    <button type="submit" form="diary-single-del-{{ d.id }}" class="btn-remove" title="ç§»é™¤æ­¤é …">âœ•</button>
                </div>
            </article>
            {% endfor %}
        </div>
        {% for d in diaries %}
        <form id="diary-single-del-{{ d.id }}" action="{{ url_for('diary_remove_batch') }}" method="post" class="hidden-form" onsubmit="return confirm('ç¢ºå®šè¦åˆªé™¤æ­¤æ—¥è¨˜å—ï¼Ÿ');">
            <input type="hidden" name="diary_ids" value="{{ d.id }}">
        </form>
        {% endfor %}
        {% else %}
        <div class="empty-state">
            <span class="empty-icon">ğŸ“”</span>
            <p>å°šç„¡æ—¥è¨˜ï¼Œå¾ä¸Šæ–¹ä¸Šå‚³ç…§ç‰‡é–‹å§‹è¨˜éŒ„</p>
        </div>
        {% endif %}
    </section>
</main>

<script>
(function() {
    const uploadZone = document.getElementById('uploadZone');
    const fileInput = document.getElementById('fileInput');
    const uploadPlaceholder = document.getElementById('uploadPlaceholder');
    const uploadPreview = document.getElementById('uploadPreview');
    const previewImg = document.getElementById('previewImg');
    const btnAnalyze = document.getElementById('btnAnalyze');
    const resultSection = document.getElementById('resultSection');
    const diaryTitle = document.getElementById('diaryTitle');
    const describeText = document.getElementById('describeText');
    const mainEmotion = document.getElementById('mainEmotion');
    const diaryMemo = document.getElementById('diaryMemo');
    const errorSection = document.getElementById('errorSection');
    const errorMsg = document.getElementById('errorMsg');
    const loading = document.getElementById('loading');

    let selectedFile = null;

    if (!uploadZone) return;

    uploadZone.addEventListener('click', () => fileInput.click());
    uploadZone.addEventListener('dragover', (e) => {
        e.preventDefault();
        uploadZone.classList.add('drag-over');
    });
    uploadZone.addEventListener('dragleave', () => uploadZone.classList.remove('drag-over'));
    uploadZone.addEventListener('drop', (e) => {
        e.preventDefault();
        uploadZone.classList.remove('drag-over');
        const file = e.dataTransfer.files[0];
        if (file && file.type.startsWith('image/')) handleFile(file);
    });
    fileInput.addEventListener('change', (e) => {
        const file = e.target.files[0];
        if (file) handleFile(file);
    });

    function handleFile(file) {
        selectedFile = file;
        previewImg.src = URL.createObjectURL(file);
        uploadPlaceholder.style.display = 'none';
        uploadPreview.style.display = 'block';
        btnAnalyze.disabled = false;
        resultSection.style.display = 'none';
        errorSection.style.display = 'none';
    }

    btnAnalyze.addEventListener('click', async () => {
        if (!selectedFile) return;
        loading.style.display = 'flex';
        resultSection.style.display = 'none';
        errorSection.style.display = 'none';

        const formData = new FormData();
        formData.append('image', selectedFile);

        try {
            const res = await fetch('/api/diary/analyze', { method: 'POST', body: formData });
            const rawText = await res.text();
            let data;
            try {
                data = rawText ? JSON.parse(rawText) : {};
            } catch (e) {
                errorMsg.textContent = 'ä¼ºæœå™¨å›å‚³é JSONã€‚' + (res.status !== 200 ? 'ç‹€æ…‹ç¢¼ï¼š' + res.status : '') + ' è«‹ç¢ºèª Ollama æœå‹™æ˜¯å¦é‹è¡Œã€‚';
                errorSection.style.display = 'block';
                loading.style.display = 'none';
                return;
            }
            if (res.status !== 200 || data.error) {
                errorMsg.textContent = data.error || 'åˆ†æå¤±æ•—';
                errorSection.style.display = 'block';
            } else {
                diaryTitle.value = data.title || '';
                describeText.value = data.describe || '';
                mainEmotion.value = data.main_emotion || '';
                diaryMemo.value = '';
                resultSection.style.display = 'block';
            }
        } catch (err) {
            errorMsg.textContent = err.message || 'ç¶²è·¯éŒ¯èª¤';
            errorSection.style.display = 'block';
        }
        loading.style.display = 'none';
    });
})();
</script>
{% endblock %}
